## 什么是MVCC  
MVCC，全称Multi-Version Concurrency Control,即多版本并发控制。MVCC是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问，在编程语言中实现事务内存  
MVCC在MySQL InnoDB存储引擎中实现主要是为了提高数据库并发访问性能，用更好的方式去处理读-写冲突，即做到即使有读写冲突时，也能做到不加锁，非阻塞并发读  
## 什么是快照读和当前读  
### 当前读  
像`select lock in share mode、select for update、insert、update、delete`这些操作就是当前读，即读取的是记录的最新版本，读取时还要保证其他并发事务不会修改当前记录，会对读取的记录加锁
### 快照读  
不加锁的读就是快照读，即普通不加锁的select语句就是快照读，也就是不加锁的非阻塞读。快照读的前提是隔离级别不能是串行化，在串行化隔离级别下，快照读会退化为当前读。之所以出现快照读，是基于提高并发性能的考虑，快照读的实现是基于MVCC。在很多情况下，MVCC避免了加锁的操作，降低了开销；既然是基于多版本并发控制，即快照读可能读到的并不是数据的最新版本而有可能是数据某一历史版本  
**总之，MVCC就是为了实现读-写不冲突，而这个读指的就是快照读而不是当前读。当前读实际上是一种加锁的操作，是悲观锁的实现**  
## MVCC能解决什么问题  
**数据库并发场景有三种**：  
1. 读-读：不存在任何问题，也不需要并发控制  
2. 读-写：有线程安全问题，可能会造成事务隔离性问题，可能遇到脏读、幻读、不可重复读  
3. 写-写：有线程安全问题，可能存在更新丢失问题。比如第一类更新丢失、第二类更新丢失  
多版本并发控制(MVCC)是一种解决读-写冲突的无锁并发控制。在并发读写时，可以做到读操作不用阻塞写操作、写操作不用阻塞读操作；同时还可以解决脏读、幻读、不可重复读等事务个理性问题，但不能解决更新丢失问题  
## MVCC实现原理  
MVCC的目的就是多版本并发控制，在数据库的实现中，就是为了解决读写冲突，它的实现原理主要依赖记录中的**3个隐式字段、undo log日志、Read View**来实现的  
### 隐式字段  
MySQL除了每行记录除了用户自已定义的字段外，还会有**DB_TRX_ID、DB_ROLL_PTR、DB_ROW_ID**等字段  
1. DB_TRX_ID  
6 byte，最近修改(更新、插入)事务ID：记录创建这条记录\最后一次修改该记录的事务ID  
2. DB_ROLL_PTR  
7 byte，回滚指针，指向这条记录的上一个版本(存储与rollback segment里)  
3. DB_ROW_ID  
6 byte，隐含的自增ID(隐藏主键)，如果数据库没有主键，InnDB会自动以DB_ROW_ID产生一个聚簇索引  
实际上还有一个删除flag隐藏字段，即记录被删除不代表真的删除，而是删除flag变了  
|name|age|DB_ROW_ID(隐式主键)|DB_TRX_ID(事务ID)||
|-|-|-|
|content1|content2|content3|




