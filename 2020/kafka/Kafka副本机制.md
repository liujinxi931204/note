所谓副本机制（Replication），也可以称之为备份机制，通常是指分布式系统在多台互联网的机器上保存有下相同的数据拷贝。副本机制一般有如下好处  

+ **提供数据冗余**：即使系统部分组件失效，系统依然能够继续运转，因而增加了整体可用性以及数据持久性  

+ **提供高伸缩性**：支持横向扩展，能够通过增加机器的方式来提升读性能，进而提高读操作吞吐量  

+ **改善数据局部性**：允许将数据放入与用户地理位置相近的地方，从而降低系统延时  

然而在Kafka的副本机制中，目前只能享受数据冗余带来的高可用和高持久性的好处。不过即便如此，副本机制依然是Kafka设计架构的核心所在，它也是Kafka确保系统高可用和消息持久性的重要基石  

### 副本定义  

Kafka是有主题概念的，而每一个主题又进一步划分为若干个分区。副本的概念实际上是在分区层级下定义的，每个分区配置有若干个副本。  

**所谓副本（Replica），本质就是一个只能追加写消息的提交日志**。根据Kafka副本机制的定义，同一个分区下的所有副本保存有相同的消息序列，这些副本分散保存在不同的Broker上，从而能够对抗部分Broker宕机带来的数据不可用  

实际上，每台Broker都可能保存有各个主题下不同分区的不同副本，因此，单个Broker上存有成百上千个副本的现象是非常正常的  

![Kafka副本机制](https://gitee.com/liujinxi931204/typoraImage/raw/master/img/Kafka%E5%89%AF%E6%9C%AC%E6%9C%BA%E5%88%B6.png)  

上图是一个有3台Broker的Kafka集群的副本分布情况。从这张图可以看到，主题1的每个分区的副本都落在了集群中的不同Broker上，从而实现了数据的冗余  

### 副本角色  

Kafka是基于领导者的副本机制。  

在Kafka中，副本分为两类：领导者副本（Leader Replica）和追随者副本（Follower Replica）。每个分区在创建时都要选举一个副本，称为领导者副本，其余的副本自动称为追随者副本  

Kafka的副本机制比其他的分布式系统要更严格一些。在Kafka中，追随者副本是不对外提供服务的。这就是说，任何一个追随者副本都不能响应消费者和生产者的读写请求。所有的请求都必须由领导者副本来处理，或者说，所有的读写请求都必须发往领导者副本所在的broker，由该broker负责处理。追随者副本不处理客户端请求，它唯一的任务就是从领导者副本**异步拉取**消息，并写入到自己提交的日志中，从而实现与领导者副本的同步  

当领导者副本挂掉了以后，或者说领导者副本所在的broker宕机时，Kafka依托于Zookeeper提供的监控功能能够实时感知到，并立即开启新一轮的领导者选举，从追随者副本中选一个作为新的领导者。老leader副本重启回来以后，只能作为追随者副本加入到集群中  

![Kafka副本拉取](https://gitee.com/liujinxi931204/typoraImage/raw/master/img/Kafka%E5%89%AF%E6%9C%AC%E6%8B%89%E5%8F%96.png)  

