redis主从模式下，一旦主节点由于故障不能提供服务，需要人工将从节点晋升为主节点，同时还需要通知应用方更新主节点地址，对于很多应用场景这种故障处理的方式是无法接受的，可以使用redis sentinel(哨兵)架构来解决这个问题  
## 基本概念  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/10/09/1602231714050-1602231714052.png)  
redis sentinel是redis高可用实现方案，在实际的生产环境中，对提高整个系统的高可用性是非常有帮助的  
### 主从复制问题  
一旦主节点出现故障，需要手动将一个从节点晋升为主节点，同时需要修改应用方的主节点地址，还需要命令其他从节点去复制新的主节点，整个过程都需要人工干预  
### 高可用  
redis sentinel正是解决  
+ 判断节点不可达的机制是否健全和标准  
+ 如果有多个从节点，怎样保证只有一个被晋升为主节点  
+ 通知客户端新的主节点机制是否足够健壮  
### redis sentinel的高可用性  
当主节点出现故障时，redis sentinel能够自动完成故障发现和故障转移，并通知应用方，从而实现真正的高可用  
redis sentinel是一个分布式结构，其中包含若干sentinel节点和redis数据节点，每个sentinel节点会对数据节点和其余sentinel节点进行监控，当发现节点不可达时，会对节点做下线标识。如果被标识的是主节点，还会和其他sentinel节点进行协商，当大多数sentinel节点都认为主节点不可达时，会选举出一个sentinel节点来完成自动故障转移的工作，同时会将这个变化实时通知给redis应用方  
redis sentinel与redis主从复制模式只是多例若干sentinel节点，并没有做其他特殊处理  
sentinel节点本身就是独立的redis节点，只不过有一些特殊，sentinel节点不存储数据，只只支持部分命令  
## 安装和部署  
#### 主节点配置文件  
```shell
daemonize yes 
port 6379
logfile "6379.log"
dbfilename "dump-6379.rdb"
dir "/search/odin/redis/data"
```  
#### 从节点配置文件  
```shell
daemonize yes 
port 6380
logfile "6380.log"
dbfilename "dump-6380.rdb"
dir "/search/odin/redis/data"
slaveof 127.0.0.1 6379
```  
可以在从节点上执行`redis-cli -h 127.0.0.1 -p 6380 info replication`命令看到  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/10/09/1602235709637-1602235709639.png)  
#### 配置sentinel节点  
+ 配置文件  
```shell
port 26379
daemonize yes
logfile "26379.log"
dir "/search/odin/redis/data"
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
```  
+ 启动sentinel  
`redis-sentinel redis-sentinel-26379.conf`  
或者  
`redis-server redis-sentinel-26379.conf --sentinel`  
+ 确认  
在sentinle节点执行命令`redis-cli -h 127.0.0.1 -p 26379 info sentinel`  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/10/09/1602236912013-1602236912015.png)  
1. 实际环境中sentinel的所有节点应该分布在不同物理机上  
2. redis sentinel中数据节点和普通的redis数据节点在配置上没有任何区别，只不过添加了一些sentinel节点对它们进行监控  
#### 配置说明  
```shell
port 26379
daemonize yes
logfile "26379.log"
dir "/search/odin/redis/data"
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
```  
port和dir分别代表sentinel节点的端口和工作目录  
+ sentinel monitor  
配置如下：  
`sentinel monitor <master-name> <ip> <port> <quorum>`  
本配置说明sentinel节点要监控的是一个名字叫做<master-name>,ip地址和端口为<ip> <port>的主节点。<quorum>代表判断主节点最终不可达所需要的票数。一般建议将<quorum>设置为sentinel节点数的一半加1  
+ sentinel down-after-milliseconds  
配置如下：  
`sentinel down-after-milliseconds <master-name> <times>`  
每个sentinel节点都要通过定期发送ping命令来判断redis数据节点和其余sentinel节点是否可达，如果超过了down-after-milliseconds配置的时间且没有有效的回复，则判定节点不可达  
实际上对sentinel节点、主节点、从节点的失败判断同时有效  
+ sentinel parallel-syncs  
配置如下：  
`sentinel parallel-syncs <master-name> <nums>`  

 




  





