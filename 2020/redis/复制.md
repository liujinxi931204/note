redis提高了复制功能，实现了相同数据的多个redis副本，复制功能时redis高可用的基础  
### 配置  
#### 建立复制  
参与复制的redis实例划分为主节点(master)和从节点(slave)。默认情况下，redis都是主节点。每个从节点只能有一个主节点，而主节点可以同时具有多个从节点。复制的数据流是单向的，只能由主节点复制到从节点。配置复制的方式有以下三种  
+ 在配置文件中加入slave {masterHost} {masterPort}随redis启动生效  
+ 在redis-server的启动命令后面加入--slaveof {masterHost} {masterPort}生效  
+ 直接使用命令slaveof {masterHost} {masterPort}生效  
#### 断开复制  
slaveof命令不但可以建立复制，还可以在从节点上执行slaveof no one来断开与主节点复制关系  
断开复制主要流程  
+ 断开与主节点复制关系  
+ 从节点晋升为主节点  
从阶段断开复制后并不会抛弃原有数据，只是无法再获取主节点上的数据变化  
通过slaveof命令还可以实现切主操作，所谓切主操作是指把当前从节点对主节点的复制切换到另一个主节点。执行slaveof {newMasterHost} {newMasterPort}命令即可  
切主操作流程如下：
+ 断开与旧主节点复制关系  
+ 与新主节点建立复制关系  
+ 删除从节点当前所有数据  
+ 对新主节点进行复制操作  
切主后从节点会清空之前所有的数据  
默认情况下，从节点使用slave-read-only=yes配置为只读模式。由于复制只能从主节点到从节点，对于从节点的任何修改住节点都无法感知，修改从节点数据会造成主从数据不一致  
redis提供了repl-disable-tcp-nodelay参数用于控制是否关闭TCP_NODELAY，默认关闭  
+ 当关闭时，主节点产生的命令数据无论大小都会及时地发送给从节点，这样主从之间延迟会变小，但增加了网络带宽消耗  
+ 当开启时，主节点会合并比较小的TCP数据包从而节省带宽。这种配置节省了带宽但增大了主从之间的延迟  
### 拓扑  
#### 一主一从  
一主一从是最简单的复制拓扑结构，用于主节点出现宕机时从节点提供故障转移支持。当应用写命令并发量较高且需要持久化时，可以只在从节点上开启AOF，这样既保证数据安全性同时也避免了持久化对主节点的性能干扰。但需要注意，当主节点关闭持久化功能时，如果主节点脱机要避免主节点自动重启操作。因为主节点之前没有开启持久化功能重启之后数据集为空，这时如果从节点继续复制会导致从节点的数据也被清空，丧失了持久化的意义。安全的做法是在从节点上执行slaveof no one断开与主节点的复制关系  
#### 一主多从  
一主多从(又称为星形拓扑结构)使得应用端可以利用多个从节点实现读写分离。对于读占比较大的场景，可以把读命令发送到从节点来分担主节点压力。对于写并发量较高的场景，多个从节点会导致主节点写命令的多次发送而过度消耗网络带宽，同时也增加了主节点的负载影响服务稳定性  
#### 树状主从  
树状主从结构(又称为树状拓扑结构)使得从节点不但可以复制主节点数据，同时可以作为其他从节点的主节点继续向下层复制。通过引入复制中间层，可以有效降低主节点负载和需要传送给从节点的数量  
### 原理  
#### 复制过程  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/09/22/1600765240920-1600765240922.png)  
复制过程大致分为6个过程  
1. 保存主节点(masyter)信息  
执行slaveof后从节点只保存主节点的地址信息便直接返回，这时建立复制流程还没有开始  
2. 从节点(slave)内部通过个每秒运行的定时任务维护复制相关逻辑，当定时任务发现存在新的主节点后，会尝试与该节点建立网络连接  
从节点会建立一个socket套接字，专门用于接受主节点发送的复制命令  
如果从节点无法建立连接，定时任务会无限重试直到连接成功或者执行slaveof no one取消复制  
3. 发送ping命令  
连接建立成功后从节点发送ping请求首次通信，ping请求的主要目的是检测主从之间的网络套接字是否可用以及主节点当前是否可以接受处理














  

