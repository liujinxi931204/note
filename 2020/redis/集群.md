redis cluster是redis的分布式解决方案  
### redis数据分区  
redis cluster采用虚拟槽分区，所有的键根据哈希函数映射到0~16383整数槽内，计算公式：slot=CRC16(key)&16383  
每个节点维护一部分槽以及槽所映射的键值数据  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/10/12/1602487937165-1602487937167.png)  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/10/12/1602487971287-1602487971288.png)  
redis虚拟槽分区的特点  
+ 解耦数据和节点之间的关系，简化了节点扩容和收缩难度  
+ 节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据  
+ 支持节点、槽、键之间的映射查询，用于数据路由、在线伸缩等场景  
集群功能限制  
redis集群相对单机在功能上存在一些限制  
+ key批量操作支持有限。如mset、mget，目前只支持具有相同slot值得key执行批量操作。对于映射为不同slot值得key由于执行mget、mset等操作可能存在多个节点上因此不被支持  
+ key事务操作支持有限。同理只支持多key在同一节点上的事务操作，当多个key分布在不同的节点上时无法使用事务功能  
+ key作为数据分区的最小粒度，因此不能将一个大的键值对象如hash、list等映射到不同的节点  
+ 不支持多数据库空间。单机下的redis可以支持16个数据库，集群模式下只能使用一个数据库空间，即db0  
+ 复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构  
## 搭建集群  
### 准备节点  
集群模式最小需要6个redis节点  
集群的配置文件如下：  
```shell
# 后台运行
daemonize yes 
#节点端口
port 6379
# 日志目录
dir "/search/odin/redis/log"
# 日志名称
logfile "6379.log"
# 数据文件
dbfilename "cluster-6379.rdb"
# 开启集群模式
cluster-enabled yes 
# 节点超时时间，单位毫秒
cluster-node-timeout 15000
# 集群内部配置文件
cluster-config-file "nodes-6379.conf"
```  
如果第一次启动时没有集群内部配置文件，会自动创建，文件由cluster-config-file控制，不要手动去修改这个文件  
这个文件记录集群的初始状态，包括集群内部唯一ID  
### 节点握手  
节点握手是指一批运行在集群模式下的节点通过Gossip协议彼此通信，达到感知对方的过程。节点握手是集群彼此通信的第一步，由客户端发起命令  
`cluster meet {ip} {port}`  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/10/12/1602492623132-1602492623136.png)  
+ 节点6379本地创建6380节点信息对象，并发送meet消息  
+ 节点6380接受到meet消息后，保存6379节点信息并回复pong消息  
+ 之后节点6379和6380彼此定期通过ping/pong消息进行正常的节点通信  
只需要在集群内任意节点执行cluster meet {ip} {port}命令加入新节点，握手状态会通过消息在集群内传播  
握手成功后集群还不能正常工作，这时集群处于下线状态，所有的数据读写都被禁止  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/10/12/1602492990181-1602492990183.png)  
可以通过执行`cluster info`命令查看集群的状态  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/10/12/1602493066463-1602493066464.png)  






