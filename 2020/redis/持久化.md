redis支持RDB和AOF两种持久化机制，持久化功能能够有效地避免因进程退出而造成的数据丢失问题，当下次重启时利用之前持久化的文件即可实现数据恢复  
## RDB  
RDB持久化是把当前进程数据生成快照保存到硬盘的过程，触发RBD持久化过程分为手动触发和自动触发  
### 触发机制  
手动触发分别对应save和bgsave命令：
+ save命令：阻塞当前redis服务器，直到RDB过程完成为止，对于内存比较大的实例会造成长时间阻塞  
+ bgsave命令：redis进程执行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束。阻塞值发生在fork阶段，一半时间很短  
1. 使用save相关配置，如"save m n",表示m秒内数据集存在n次修改时，自动触发bgsave  
2. 如果从节点执行全量复制操作，主节点自动执行bgsave生成RDB文件并发送给从节点  
3. 执行debug reload命令重新加载redis时，也会自动触发save操作  
4. 默认情况下执行shutdown命令时，如果没有开启AOF持久化功能则会自动执行bgsave  
### 流程说明  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/09/18/1600416227834-1600416227895.png)  
+ 执行bgsave命令，redis父进程判断当前是否存在正在执行的子进程，如RDB/AOF子进程，如果存在bgave命令直接返回  
+ 父进程执行fork操作创建子进程，fork操作过程中父进程会阻塞，通过info stats命令查看latest_fork_usec选项，可以获得最近一个fork操作的耗时，单位为毫秒  
+ 父进程fork完成后，bgsave命令返回"background saveing started"信息并不再阻塞父进程，可以继续相应其他的命令  
+ 子进程创建RDB文件，根据父进程内存生成临时快照文件，完成后对原有文件进行原子替换。执行lastsave命令可以获取最后一次生成RDB的时间，对应info统计的rdb_last_save_time选项  
+ 进程发送信号给父进程表示完成，父进程更新统计信息  
### RDB文件的处理  
+ 保存：RDB文件保存在dir配置指定的目录下，文件名通过dbfilename配置指定  
当遇到坏盘或磁盘写满等情况时，可以通过config set dir {newdir}在线修改文件路径到可用的磁盘路径，之后执行bgsave进行磁盘切换，同样适用于AOF持久化文件  
+ 压缩：redis默认采用LZF算法对生成的RDB文件做压缩处理，压缩后的文件远远小于内存大小，默认开启，可以通过个参数 config set rdbcompression {yes|no}动态修改  
+ 如果redis加载损坏的RDB文件时拒绝启动，可以使用redis提供的redis-check-dump工具检测RDB文件并获取对应的错误报告  
### RDB的优缺点  
+ 优点  
1. RDB是一个紧凑压缩的二进制文件，代表redis在某个时间点上的数据快照。非常适用于备份、全量复制等场景  
2. redis加载RDB恢复数据远远快于AOF的方式  
+ 缺点  
1. RDB方式数据没办法做到实时持久化/秒级持久化。因为bgsave每次运行都要执行fork操作创建子进程，属于重量级操作，频繁执行成本过高  
2. RDB文件使用特定的二进制格式保存，redis版本演进过程中有多个格式的RDB版本，存在老版本redis服务无法兼容新版本RDB格式的问题  
## AOF  
AOF(append only file)持久化：以独立日志的方式记录每次写命令，重启时再重新执行AOF文件中的命令达到恢复数据的目的。AOF的主要作用时解决了数据持久化的实时性  
### 使用AOF  
开启AOF功能需要设置配置：appendonly yes,默认开启  
AOF的工作流程：命令写入(append)、文件同步(sync)、文件重写(rewrite)、重启加载(load)  
![title](https://raw.githubusercontent.com/liujinxi931204/image/master/gitnote/2020/09/21/1600674526274-1600674526319.png)   
流程如下  
+ 所有的写入命令会追加到aof_buf(缓冲区)中  
+ AOF缓冲区根据对应的策略向硬盘做同步操作  
+ 随着AOF文件越来越大，需要定期对AOF文件进行重写，达到压缩的目的  
+ 当redis服务重启时，可以加载AOF文件进行数据恢复  
#### 命令写入  
AOF命令写入的内容直接是文本协议格式  
AOF为什么把命令追加到











